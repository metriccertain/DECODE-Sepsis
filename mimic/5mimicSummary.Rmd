---
title: "5mimicSummary"
author: "Andrew Hanson"
output: html_document
---

```{r setup, include=FALSE}
# run this program
# Rscript -e "rmarkdown::render('5mimicSummary.Rmd')"

knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(pROC)

# given a <data> set of <response> and <predictor>, output calibration data, calibration deciles, and a calibration plot
get_cal_data <- function(data, response, predictor) {
  my_quantiles <- seq(0,1,0.1)
  
  cal_data <- data %>%
    rename(
      pred = !!predictor, event = !!response
    ) %>%
    dplyr::select(
      pred, event
    ) %>%
    mutate(
      score_decile = cut(pred, breaks=quantile(pred, my_quantiles) - c(1E-4, rep(0, length(my_quantiles)-1))),
      score_decile = floor(10*pred)
    )
  
  cal_data_deciles <- data.frame(score_decile = 0:9)
  
  tmp <- cal_data %>%
    group_by(score_decile) %>%
    mutate(
      n_decile = n(),
      sum_event = sum(event),
      mean_pred = mean(pred)
    ) %>%
    slice_head(n=1) %>%
    ungroup()
  
  cal_data_deciles <- cal_data_deciles %>%
    left_join(tmp, join_by(score_decile))
  
  tmp <- DescTools::BinomCI(x=cal_data_deciles$sum_event, n=cal_data_deciles$n_decile)
  
  cal_data_deciles <- cal_data_deciles %>%
    bind_cols(tmp)
  
  out <- list(cal_data = cal_data, cal_data_deciles = cal_data_deciles)
  
  return(out)
}
```

```{r read_predicteds}
pred_nn <- read.csv(file='./results/v4/ztest_mimicNN_predicted.csv') %>%
  dplyr::select(
    subject_id, hadm_id, stay_id, admit_id, session_id, starts_with('yhat')
  )

pred_rnn <- read.csv(file='./results/v4/ztest_mimicRNN_merged_predicted.csv') %>%
  dplyr::select(
    subject_id, hadm_id, stay_id, admit_id, session_id, starts_with('yhat')
  )

preds <- pred_nn %>%
  left_join(pred_rnn, join_by(subject_id, hadm_id, stay_id, admit_id, session_id))

preds <- preds %>%
  rename_with(~gsub('yhat_', '', .x)) %>%
  dplyr::select(
    subject_id, hadm_id, stay_id, session_id, merged_cnnsmall, merged_cnntiny, 
    merged_lstmsmall, merged_lstmtiny, nn
  )

preds <- preds %>%
  mutate(
    merged_ensemble = (merged_cnnsmall + merged_cnntiny + merged_lstmsmall + merged_lstmtiny + nn)/5
  ); dim(preds)
```

```{r load_mimic_demo_data}
# MIMIC data
mimic_main <- read.csv('./derived/v4/demo.csv')

mimic_main <- mimic_main %>%
  mutate(
    hosp_death = hospital_expire_flag,
    prlos_death = case_when(
      hosp_death == 1 ~ 1,
      as.numeric(difftime(outtime, intime, units='days')) > 14 ~ 1,
      TRUE ~ 0
    )
  )
```

```{r mimic_sofa}
# hourly sofa over the first day
sofa_mimic <- read.csv(file='./derived/v4/sofa.csv')

# SOFA >= 2 within 24 hours
sofa_mimic <- sofa_mimic %>%
  filter(
    hr <= 24
  )

sofa_mimic <- sofa_mimic %>%
  arrange(stay_id, hr) %>%
  group_by(stay_id) %>%
  slice_tail(n=1) %>%
  ungroup() %>%
  dplyr::select(
    stay_id, sofa_24hours
  )

mimic_main <- mimic_main %>%
  inner_join(sofa_mimic, join_by(stay_id)); dim(mimic_main)

rm(sofa_mimic)
```

```{r mimic_aps}
mimic_aps <- read.csv(file='./derived/v4/apsiii.csv')

mimic_aps <- mimic_aps %>%
  rename(
    aps_24 = apsiii, aps_24prob = apsiii_prob
  ) %>%
  dplyr::select(
    subject_id, hadm_id, stay_id, aps_24, aps_24prob
  ) %>%
  distinct()

mimic_main <- mimic_main %>%
  left_join(mimic_aps, join_by(subject_id, hadm_id, stay_id))

rm(mimic_aps)
```

```{r mimic_saps}
mimic_saps <- read.csv(file='./derived/v4/sapsii.csv')

mimic_saps <- mimic_saps %>%
  dplyr::select(
    subject_id, hadm_id, stay_id, sapsii, sapsii_prob
  ) %>%
  distinct(); dim(mimic_saps)

mimic_main <- mimic_main %>%
  left_join(mimic_saps, join_by(subject_id, hadm_id, stay_id)); dim(mimic_main)

rm(mimic_saps)
```

```{r create_phats}
tmp <- mimic_main %>%
  dplyr::select(
    subject_id, hadm_id, stay_id, aps_24, aps_24prob, sofa_24hours, sapsii_prob, prlos_death
  )

mimic_phats <- preds %>%
  inner_join(tmp, join_by(subject_id, hadm_id, stay_id)); dim(mimic_phats)

mimic_phats <- mimic_phats %>%
  mutate(
    aps_24 = if_else(is.na(aps_24), mean(aps_24, na.rm=TRUE), aps_24),
    aps_24prob = if_else(is.na(aps_24prob), mean(aps_24prob, na.rm=TRUE), aps_24prob),
    aps_24prob = round(aps_24prob, digits=3)
  )
```

```{r, message = FALSE}
my_probs <- c('merged_ensemble', 'aps_24prob', 'sapsii_prob')
my_preds <- c(my_probs, 'sofa_24hours')

mimic_phats_list <- split(mimic_phats, factor(mimic_phats$session_id))

# roc_lists are lists of predictors, each being a list of session_ids with associated roc objects
mimic_roc_list <- split(my_preds, factor(my_preds))[my_preds]

for (pred in my_preds) {
  mimic_roc_list[[pred]] <- lapply(mimic_phats_list, FUN = function(x) roc(response=x[['prlos_death']], predictor=round(x[[pred]], digits=3)))
}

# cal list is a list of predictors, each being a list of session_ids with associated calibration objects (lists)
mimic_cal_list <- split(my_probs, factor(my_probs))[my_probs]

for (prob in my_probs) {
  mimic_cal_list[[prob]] <- lapply(mimic_phats_list, FUN = function(x) get_cal_data(data=x, response='prlos_death', predictor=prob))
}

# get ROC plot data for each dataset, every model, and every session_id
mimic_roc_data <- mimic_roc_list

for (mod in names(mimic_roc_list)) {
  for (id in names(mimic_roc_list[[mod]])) {
    mimic_roc_data[[mod]][[id]] <- coords(mimic_roc_list[[mod]][[id]], ret = c('threshold','recall','fpr','precision')) %>%
      mutate(
        model = mod, session_id = id, hours = as.numeric(session_id) / 4
      )
  }
  mimic_roc_data[[mod]] <- do.call(rbind, mimic_roc_data[[mod]])
}

# get calibration plot data for each dataset, every model, and every session_id
mimic_cal_data <- mimic_cal_list

for (mod in names(mimic_cal_list)) {
  for (id in names(mimic_cal_list[[mod]])) {
    mimic_cal_data[[mod]][[id]] <- mimic_cal_list[[mod]][[id]]$cal_data_deciles %>%
      mutate(
        model = mod, session_id = id, hours = as.numeric(session_id) / 4
      )
  }
  mimic_cal_data[[mod]] <- do.call(rbind, mimic_cal_data[[mod]])
}

# get AUC for each dataset, every model, and every session_id
mimic_auc_data <- lapply(mimic_roc_list, FUN = function(x) do.call(rbind, lapply(x, FUN = function(y) data.frame(AUC = as.numeric(auc(y))))))
```

## AU ROC (MIMIC IV)

### Ensemble model at 2, 6, 12, 18, and 24 hours

#### 2 hours

```{r}
auc(mimic_roc_list$merged_ensemble$`8`)
ci.auc(mimic_roc_list$merged_ensemble$`8`)
```

#### 6 hours

```{r}
auc(mimic_roc_list$merged_ensemble$`24`)
ci.auc(mimic_roc_list$merged_ensemble$`24`)
```

#### 12 hours

```{r}
auc(mimic_roc_list$merged_ensemble$`48`)
ci.auc(mimic_roc_list$merged_ensemble$`48`)
```

#### 18 hours

```{r}
auc(mimic_roc_list$merged_ensemble$`72`)
ci.auc(mimic_roc_list$merged_ensemble$`72`)
```

#### 24 hours

```{r}
auc(mimic_roc_list$merged_ensemble$`96`)
ci.auc(mimic_roc_list$merged_ensemble$`96`)
```

### SOFA at 24 hours

```{r}
auc(mimic_roc_list$sofa_24hours$`96`)
ci.auc(mimic_roc_list$sofa_24hours$`96`)
```

```{r}
roc.test(mimic_roc_list$merged_ensemble$`96`, mimic_roc_list$sofa_24hours$`96`)
```

### SAPS II at 24 hours

```{r}
auc(mimic_roc_list$sapsii$`96`)
ci.auc(mimic_roc_list$sapsii$`96`)
```

```{r}
roc.test(mimic_roc_list$merged_ensemble$`96`, mimic_roc_list$sapsii$`96`)
```

## AU ROC

```{r}
plt_data <- mutate(mimic_roc_data$merged_ensemble, COHORT = 3, timept = paste(hours, '-hours', sep='')) %>%
  bind_rows(mutate(mimic_roc_data$merged_ensemble, COHORT = 3, timept = 'Comparator, 24-hours')) %>%
  bind_rows(mutate(mimic_roc_data$sofa_24hours, COHORT = 4, timept = 'Comparator, 24-hours')) %>%
  bind_rows(mutate(mimic_roc_data$sapsii, COHORT = 5, timept = 'Comparator, 24-hours'))

plt_data <- plt_data %>%
  filter(
    hours %in% c(6, 12, 24)
  ) %>%
  filter(
    !(timept == 'Comparator, 24-hours' & hours < 24)
  )

plt_data <- plt_data %>%
  mutate(
    COHORT = factor(COHORT, levels=3:5, 
      labels=c('External test (MIMIC-IV)','SOFA (MIMIC-IV)','SAPSII (MIMIC-IV)')),
    timept = factor(timept, levels=c('6-hours','12-hours','24-hours','Comparator, 24-hours'))
  )

plt <- ggplot(data=plt_data, aes(x=fpr, y=recall, color=COHORT)) + geom_step(size=0.5) + 
  facet_wrap(~timept) + scale_x_continuous(breaks=seq(0.2,1,0.2), name='1-Specificity') +
  scale_y_continuous(breaks=seq(0.2,1,0.2), name='Sensitivity') +
  geom_abline(slope=1, intercept=0, col='firebrick') + theme_light() + 
  theme(aspect.ratio=1, axis.text = element_text(size=12), 
        axis.title = element_text(size=12), legend.position="bottom", legend.direction = "horizontal",
        legend.title=element_blank(), legend.text = element_text(size=12), 
        strip.text = element_text(size=10)) + guides(color=guide_legend(nrow=2, byrow=TRUE))

plt
```

## Precision-recall

```{r}
plt <- ggplot(data=plt_data, aes(x=recall, y=precision, color=COHORT)) + geom_step(size=0.5) +
  facet_wrap(~timept) + scale_x_continuous(breaks=seq(0.2,1,0.2), limits=c(0,1), name = 'Recall') + 
  scale_y_continuous(breaks=seq(0.2,1,0.2), limits=c(0,1), name = 'Precision') +
  geom_abline(slope=0, intercept=0.2047, col="darkgreen") + theme_light() +
  theme(aspect.ratio=1, axis.text = element_text(size=12), 
        axis.title = element_text(size=12), legend.position="bottom", legend.direction = "horizontal",
        legend.title=element_blank(), legend.text = element_text(size=12), 
        strip.text = element_text(size=10)) + guides(color=guide_legend(nrow=2, byrow=TRUE))

plt
```

## Calibration

```{r}
plt_data <- mutate(mimic_cal_data$merged_ensemble, COHORT = 3, timept = paste(hours, '-hours', sep='')) %>%
  bind_rows(mutate(mimic_cal_data$merged_ensemble, COHORT = 3, timept = 'Comparator, 24-hours')) %>%
  bind_rows(mutate(mimic_cal_data$sapsii, COHORT = 4, timept = 'Comparator, 24-hours'))

plt_data <- plt_data %>%
  filter(
    hours %in% c(6, 12, 24)
  ) %>%
  filter(
    !(timept == 'Comparator, 24-hours' & hours < 24)
  )

plt_data <- plt_data %>%
  mutate(
    COHORT = factor(COHORT, levels=3:4, 
      labels=c('External test (MIMIC-IV)','SAPSII (MIMIC-IV)')),
    timept = factor(timept, levels=c('6-hours','12-hours','24-hours','Comparator, 24-hours'))
  )

plt <- ggplot(plt_data, aes(x=mean_pred, y=est, ymin=lwr.ci, ymax=upr.ci, color=COHORT)) + facet_wrap(~timept) +
  geom_pointrange(size=0.1) + scale_x_continuous(breaks=seq(0.2,1,0.2), limits=c(0,1), name='Mean predicted') + 
  scale_y_continuous(breaks=seq(0.2,1,0.2), limits=c(0,1), name='Observed rate') + geom_abline(slope=1, intercept=0, col="grey")+
  theme_light() + theme(aspect.ratio=1, axis.text = element_text(size=12), 
        axis.title = element_text(size=12), legend.position="bottom", legend.direction = "horizontal",
        legend.title=element_blank(), legend.text = element_text(size=12), 
        strip.text = element_text(size=10)) + guides(color=guide_legend(nrow=2, byrow=TRUE))

plt
```
